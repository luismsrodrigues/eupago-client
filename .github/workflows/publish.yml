# .github/workflows/publish.yml
name: Test and Publish to NPM

on:
  push:
    tags:
      - 'v*.*.*'    # e.g. v1.2.3

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: ⬇️ Checkout code (with full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🟢 Setup Node.js & NPM auth
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          scope: '@luisrodrigues'
          always-auth: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 🔑 Write project .npmrc
        run: |
          echo "@luisrodrigues:registry=https://registry.npmjs.org/" > .npmrc
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" >> .npmrc
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: 📦 Install dependencies
        run: yarn install --frozen-lockfile

      - name: 🧪 Run tests
        env:
          API_KEY: ${{ secrets.EUPAGO_API_KEY }}
        run: yarn test --ci

      - name: 🔨 Build
        run: yarn build

      - name: 🚀 Publish to NPM
        run: npm publish --access public --registry=https://registry.npmjs.org/
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
